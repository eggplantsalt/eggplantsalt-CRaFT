# CRaFT (Constrained Retention Fine-Tuning) è®­ç»ƒæ¡†æ¶

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/lerobot/craft/                    # CRaFT æ ¸å¿ƒåŒ…
â”œâ”€â”€ __init__.py                       # åŒ…åˆå§‹åŒ–ï¼Œå¯¼å‡º CraftConfig
â”œâ”€â”€ README.md                         # æœ¬æ–‡ä»¶ï¼šCRaFT æ–‡ä»¶è¯´æ˜
â”œâ”€â”€ craft_config.py                   # CRaFT é…ç½®ç±»ï¼ˆè¶…å‚æ•°å®šä¹‰ï¼‰
â”œâ”€â”€ grad_surgery.py                   # æ¢¯åº¦æ‰‹æœ¯æ¨¡å—ï¼ˆæŠ•å½±ã€åˆå¹¶ï¼‰
â”œâ”€â”€ primal_dual.py                    # åŸå¯¹å¶ä¼˜åŒ–ï¼ˆÎ» æ›´æ–°ã€Îµ è°ƒåº¦ï¼‰
â”œâ”€â”€ retention_loss.py                 # ä¿ç•™æŸå¤±è®¡ç®—
â””â”€â”€ anchor_cache.py                   # é”šç‚¹æ•°æ®é›†åŠ è½½å™¨

src/lerobot/scripts/
â””â”€â”€ lerobot_train_craft.py            # CRaFT è®­ç»ƒå…¥å£è„šæœ¬

tests/
â””â”€â”€ test_grad_surgery_math.py         # æ¢¯åº¦æ‰‹æœ¯å•å…ƒæµ‹è¯•

æ ¹ç›®å½•/
â”œâ”€â”€ progress.txt                      # é¡¹ç›®è¿›åº¦è·Ÿè¸ªæ–‡æ¡£
â””â”€â”€ tests.json                        # æµ‹è¯•è®¡åˆ’å’Œé˜¶æ®µå®šä¹‰
```

## ğŸ¯ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. craft_config.py
**ä½œç”¨**: å®šä¹‰ CRaFT è®­ç»ƒçš„æ‰€æœ‰è¶…å‚æ•°é…ç½®

**å…³é”®å‚æ•°**:
- `anchor_dataset_path`: é”šç‚¹æ•°æ®é›†è·¯å¾„ï¼ˆæ—§ä»»åŠ¡æ•°æ®ï¼‰
- `initial_lambda`: åˆå§‹ Lagrangian ä¹˜å­ Î»ï¼ˆæ§åˆ¶ä¿ç•™æŸå¤±æƒé‡ï¼‰
- `epsilon_start/end`: ä¿ç•™æŸå¤±é˜ˆå€¼çš„èµ·å§‹/ç»“æŸå€¼
- `use_grad_projection`: æ˜¯å¦å¯ç”¨æ¢¯åº¦æŠ•å½±ï¼ˆè§£å†³æ¢¯åº¦å†²çªï¼‰

### 2. grad_surgery.py
**ä½œç”¨**: å®ç°æ¢¯åº¦æ‰‹æœ¯ç®—æ³•ï¼Œè§£å†³ä»»åŠ¡æŸå¤±å’Œä¿ç•™æŸå¤±çš„æ¢¯åº¦å†²çª

**æ ¸å¿ƒå‡½æ•°**:
- `compute_dot()`: è®¡ç®—ä¸¤ä¸ªæ¢¯åº¦å‘é‡çš„ç‚¹ç§¯ï¼ˆåˆ¤æ–­æ˜¯å¦å†²çªï¼‰
- `project_if_conflict()`: å½“æ¢¯åº¦å†²çªæ—¶è¿›è¡ŒæŠ•å½±
- `merge_grads()`: åˆå¹¶ä»»åŠ¡æ¢¯åº¦å’Œä¿ç•™æ¢¯åº¦

**ç®—æ³•åŸç†**: åŸºäº PCGradï¼Œå½“ä¸¤ä¸ªç›®æ ‡çš„æ¢¯åº¦æ–¹å‘å†²çªï¼ˆè´Ÿç‚¹ç§¯ï¼‰æ—¶ï¼Œå°†ä»»åŠ¡æ¢¯åº¦æŠ•å½±åˆ°ä¿ç•™æ¢¯åº¦çš„æ³•å¹³é¢ä¸Šã€‚

### 3. primal_dual.py
**ä½œç”¨**: å®ç°åŸå¯¹å¶ä¼˜åŒ–ï¼ŒåŠ¨æ€è°ƒæ•´ä¿ç•™æŸå¤±çš„æƒé‡

**æ ¸å¿ƒå‡½æ•°**:
- `epsilon_schedule()`: è®¡ç®—å½“å‰æ­¥çš„ä¿ç•™æŸå¤±é˜ˆå€¼ Îµ(t)
- `update_lambda()`: æ›´æ–° Lagrangian ä¹˜å­ Î»

**ä¼˜åŒ–ç›®æ ‡**:
```
min L_task(Î¸)
s.t. L_retain(Î¸) â‰¤ Îµ(t)
```

é€šè¿‡ Î» çš„æ¢¯åº¦ä¸Šå‡å®ç°çº¦æŸä¼˜åŒ–ï¼š
```
Î»_{t+1} = clip(Î»_t + Î»_lr * (L_retain - Îµ), 0, Î»_max)
```

### 4. retention_loss.py
**ä½œç”¨**: åœ¨é”šç‚¹æ•°æ®ä¸Šè®¡ç®—ä¿ç•™æŸå¤±ï¼Œè¡¡é‡æ¨¡å‹å¯¹æ—§ä»»åŠ¡çš„è®°å¿†ç¨‹åº¦

**æ ¸å¿ƒå‡½æ•°**:
- `compute_retention_loss()`: è°ƒç”¨ policy.forward() åœ¨é”šç‚¹æ•°æ®ä¸Šè®¡ç®—æŸå¤±

### 5. anchor_cache.py
**ä½œç”¨**: ç®¡ç†é”šç‚¹æ•°æ®é›†çš„åŠ è½½å’Œé‡‡æ ·

**æ ¸å¿ƒç±»/å‡½æ•°**:
- `AnchorCacheDataset`: é”šç‚¹æ•°æ®é›†åŒ…è£…å™¨
- `create_anchor_dataloader()`: åˆ›å»ºé”šç‚¹æ•°æ®çš„ DataLoader

### 6. lerobot_train_craft.py
**ä½œç”¨**: CRaFT è®­ç»ƒçš„ä¸»å…¥å£è„šæœ¬ï¼Œæ‰©å±•è‡ª baseline çš„ lerobot_train.py

**æ ¸å¿ƒå‡½æ•°**:
- `train_craft()`: ä¸»è®­ç»ƒå¾ªç¯
- `update_policy_craft()`: å•æ­¥è®­ç»ƒæ›´æ–°ï¼ˆåŒå‘åä¼ æ’­ + æ¢¯åº¦æ‰‹æœ¯ï¼‰

**è®­ç»ƒæµç¨‹**:
```
for step in range(steps):
    1. å‰å‘ä¼ æ’­ï¼ˆä»»åŠ¡æ•°æ®ï¼‰â†’ L_task
    2. åå‘ä¼ æ’­ â†’ âˆ‡L_task
    3. å‰å‘ä¼ æ’­ï¼ˆé”šç‚¹æ•°æ®ï¼‰â†’ L_retain
    4. åå‘ä¼ æ’­ â†’ âˆ‡L_retain
    5. æ¢¯åº¦æ‰‹æœ¯ï¼ˆæŠ•å½± + åˆå¹¶ï¼‰
    6. ä¼˜åŒ–å™¨æ›´æ–°
    7. æ›´æ–° Î»ï¼ˆåŸå¯¹å¶ï¼‰
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### Dry-Run æµ‹è¯•ï¼ˆå½“å‰å¯ç”¨ï¼‰
```bash
python src/lerobot/scripts/lerobot_train_craft.py \
    --policy.type=pi0_fast \
    --dataset.repo_id=lerobot/aloha_sim_insertion_human \
    --batch_size=8 \
    --steps=1 \
    --output_dir=outputs/craft_dryrun
```

### å®Œæ•´è®­ç»ƒï¼ˆå¾…å®ç°åï¼‰
```bash
python src/lerobot/scripts/lerobot_train_craft.py \
    --policy.type=pi0_fast \
    --dataset.repo_id=lerobot/aloha_sim_insertion_human \
    --batch_size=32 \
    --steps=10000 \
    --output_dir=outputs/craft_full \
    --craft.anchor_dataset_path=path/to/anchor/data \
    --craft.initial_lambda=1.0 \
    --craft.epsilon_start=1.0 \
    --craft.epsilon_end=0.1
```

## ğŸ“Š å®ç°çŠ¶æ€

- âœ… **é˜¶æ®µ 1**: è„šæ‰‹æ¶æ­å»ºï¼ˆå·²å®Œæˆï¼‰
  - æ‰€æœ‰æ¨¡å—çš„å‡½æ•°ç­¾åå’Œæ–‡æ¡£å·²å®Œæˆ
  - Dry-run æ¨¡å¼å¯è¿è¡Œ

- ğŸš§ **é˜¶æ®µ 2**: æ ¸å¿ƒç®—æ³•å®ç°ï¼ˆå¾…å®Œæˆï¼‰
  - grad_surgery.py çš„æ•°å­¦è¿ç®—
  - primal_dual.py çš„ä¼˜åŒ–é€»è¾‘
  - retention_loss.py çš„æŸå¤±è®¡ç®—

- ğŸš§ **é˜¶æ®µ 3**: æ•°æ®ç®¡é“ï¼ˆå¾…å®Œæˆï¼‰
  - anchor_cache.py çš„æ•°æ®åŠ è½½
  - ä¸è®­ç»ƒå¾ªç¯çš„é›†æˆ

- ğŸš§ **é˜¶æ®µ 4**: è®­ç»ƒå¾ªç¯ï¼ˆå¾…å®Œæˆï¼‰
  - update_policy_craft() çš„å®Œæ•´å®ç°
  - åŒå‘åä¼ æ’­å’Œæ¢¯åº¦æå–

## ğŸ“ ä¸ Baseline çš„åŒºåˆ«

| ç‰¹æ€§ | Baseline (lerobot_train.py) | CRaFT (lerobot_train_craft.py) |
|------|----------------------------|--------------------------------|
| è®­ç»ƒç›®æ ‡ | å•ç›®æ ‡ï¼ˆä»»åŠ¡æŸå¤±ï¼‰ | åŒç›®æ ‡ï¼ˆä»»åŠ¡ + ä¿ç•™ï¼‰ |
| åå‘ä¼ æ’­ | 1 æ¬¡/æ­¥ | 2 æ¬¡/æ­¥ |
| æ¢¯åº¦å¤„ç† | ç›´æ¥ä½¿ç”¨ | æŠ•å½± + åˆå¹¶ |
| æŸå¤±æƒé‡ | å›ºå®š | åŠ¨æ€è°ƒæ•´ï¼ˆÎ»ï¼‰ |
| æ•°æ®æº | å•æ•°æ®é›† | ä»»åŠ¡æ•°æ® + é”šç‚¹æ•°æ® |

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `progress.txt`: è¯¦ç»†çš„å®ç°è¿›åº¦å’Œä¸‹ä¸€æ­¥è®¡åˆ’
- `tests.json`: æµ‹è¯•å¥—ä»¶å®šä¹‰å’ŒéªŒæ”¶æ ‡å‡†
- `tests/test_grad_surgery_math.py`: å•å…ƒæµ‹è¯•æ¡†æ¶

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸ä¿®æ”¹ baseline**: `lerobot_train.py` ä¿æŒåŸæ ·ï¼Œç¡®ä¿å‘åå…¼å®¹
2. **ä¸ä¿®æ”¹ policy**: `pi0_fast` çš„æ¨¡å‹ç»“æ„ä¸å˜ï¼Œåªåœ¨è®­ç»ƒå±‚é¢æ‰©å±•
3. **æ¨¡å—åŒ–è®¾è®¡**: æ‰€æœ‰ CRaFT é€»è¾‘å°è£…åœ¨ `craft/` åŒ…ä¸­ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤

