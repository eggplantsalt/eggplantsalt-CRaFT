# CRaFT 项目进度 - Hidden State Anchoring 版本

## 最新更新：Hidden State Anchoring 实现（2025-02-17）

### 改动概述

将 CRaFT 的 retention 分支从 token-level teacher distillation 改为 hidden-state anchoring（表征蒸馏），解决 π0_fast 不稳定输出自然语言的问题。

### 核心改动

1. **build_anchor_cache.py**（完全重写）
   - 不再保存 teacher tokens/labels
   - 改为保存 teacher hidden states（最后两层）
   - Pooling 策略：vision_token_mean + text_token_last
   - Cache 大小减少 ~60 倍

2. **anchor_cache.py**（更新）
   - 自动检测 cache 类型（hidden-state 或 token-level）
   - 向后兼容旧版本 token-level cache

3. **retention_loss.py**（完全重写）
   - 新增 `compute_retention_loss_hidden()`：支持 MSE/Cosine/L1 loss
   - 新增 `extract_student_hidden_with_pooling()`：提取 student hidden states
   - 保留 `compute_retention_loss()` 用于向后兼容

4. **lerobot_train_craft.py**（更新）
   - `update_policy_craft()` 自动检测 cache 类型
   - 支持 hidden state anchoring 和 token-level distillation
   - 日志显示 cache_type

5. **测试**
   - 新增 `tests/test_hidden_state_anchoring.py`（5 个单元测试）

### 使用方法

#### 生成 Hidden State AnchorCache

```bash
python -m lerobot.scripts.build_anchor_cache \
    --policy.pretrained_path=physical-intelligence/pi0-fast \
    --dataset.repo_id=lerobot/aloha_sim_insertion_human \
    --out_dir=data/anchor_cache_hidden \
    --num_anchors=1000 \
    --layers_to_save=-2,-1
```

#### 训练（自动检测 cache 类型）

```bash
python -m lerobot.scripts.lerobot_train_craft \
    --dataset.repo_id=lerobot/aloha_sim_insertion_human \
    --policy.path=lerobot/pi0_fast \
    --output_dir=outputs/craft_hidden \
    --steps=1000 \
    --batch_size=8
```

#### Dry-Run 测试

```bash
python -m lerobot.scripts.lerobot_train_craft \
    --dataset.repo_id=lerobot/aloha_sim_insertion_human \
    --policy.path=lerobot/pi0_fast \
    --output_dir=outputs/craft_dryrun \
    --steps=2 \
    --batch_size=2 \
    --eval_freq=0 \
    --save_checkpoint=false \
    --num_workers=0
```

### 验收标准

- ✅ Baseline 训练脚本不被破坏
- ✅ 旧版本 token-level cache 仍可使用
- ✅ 新版本 hidden state cache 正确加载
- ✅ K-step 时能完成 L_ret backward、grad surgery、λ update
- ✅ 单元测试通过

### Git Commit

```
commit: feat: switch retention to hidden-state anchoring (offline teacher cache)

Changes:
- src/lerobot/scripts/build_anchor_cache.py (完全重写)
- src/lerobot/craft/anchor_cache.py (更新)
- src/lerobot/craft/retention_loss.py (完全重写)
- src/lerobot/scripts/lerobot_train_craft.py (更新)
- tests/test_hidden_state_anchoring.py (新增)
- HIDDEN_STATE_ANCHORING_GUIDE.md (新增)
- progress.txt (更新)
```

---

## 历史记录

### 第四阶段：CRaFT 训练核心算法实现（已完成，2025-02-15）

**目标：** 实现 CRaFT 训练的核心算法逻辑，真正接入训练流程。

**完成内容：**
1. grad_surgery.py（完整实现）
2. primal_dual.py（完整实现）
3. craft_config.py（更新）
4. lerobot_train_craft.py（完整实现）
5. 训练脚本和文档

### 第三阶段：AnchorCache 离线生成和读取（已完成，2025-02-15）

**目标：** 实现 AnchorCache 的完整功能。

**完成内容：**
1. build_anchor_cache.py（550+ 行，token-level 版本）
2. anchor_cache.py（完整实现）
3. test_anchor_cache.py（300+ 行，5 个测试）
4. 文档

### 第二阶段：整理和注释（已完成）

**目标：** 为所有 CRaFT 相关文件添加详细中文注释。

### 第一阶段：脚手架搭建（已完成）

**目标：** 搭建 CRaFT 框架的基本结构。

---

## 项目文件结构

```
src/lerobot/craft/
├── __init__.py
├── craft_config.py
├── grad_surgery.py
├── primal_dual.py
├── anchor_cache.py
├── retention_loss.py

src/lerobot/scripts/
├── build_anchor_cache.py
└── lerobot_train_craft.py

tests/
├── test_anchor_cache.py
├── test_hidden_state_anchoring.py
└── test_grad_surgery_math.py

scripts/
├── train_craft.sh
└── train_craft_dryrun.sh

docs/
├── CRAFT_FILES.md
├── ANCHOR_CACHE_GUIDE.md
├── ANCHOR_CACHE_SUMMARY.md
├── CRAFT_TRAINING_GUIDE.md
├── CRAFT_INTEGRATION_SUMMARY.md
└── HIDDEN_STATE_ANCHORING_GUIDE.md
```

## 下一步

1. 在真实数据集上测试 hidden state anchoring
2. 对比 hidden state vs token-level 的性能
3. 更新所有文档以反映 hidden state anchoring
4. 性能优化和超参数调优
