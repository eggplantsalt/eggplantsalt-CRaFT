# CRaFT 项目进度 - Hidden State Anchoring 版本

## 最新更新：修复 CRaFT 训练关键 Bug（2025-02-17）

### 修复内容

**问题 1：AnchorCache 加载时 preprocessor 未创建**
- 原因：在 preprocessor 创建前尝试传递给 AnchorCacheDataset
- 修复：
  - 将 AnchorCache 加载移到 preprocessor 创建之后
  - AnchorCacheDataset 不再接受 transform 参数，返回 raw batch
  - 在训练循环中对 anchor_batch 调用 preprocessor(anchor_batch)
- 验证：启用 craft.enabled=true 且提供 anchor_cache_dir 时，不会触发 try/except 导致 craft_config.enabled=False

**问题 2：梯度冲突日志错误**
- 原因：输出的是 dot product，却打印成 cos（余弦相似度）
- 修复：
  - 实现并记录两个值：grad_dot（点积）和 grad_cos（余弦相似度）
  - grad_cos = dot / (sqrt(norm_sq_task) * sqrt(norm_sq_ret) + 1e-12)
  - 日志同时显示：`dot=X.XXX | cos=X.XXX`
- 验证：日志中同时显示 dot 和 cos 两个指标

**问题 3：dot product 计算错位**
- 原因：使用"过滤 None 后两列表直接 dot"会导致位置不对应
- 修复：
  - 使用 zip(task_grads, ret_grads) 同位置配对
  - 累加 dot 时跳过任一为 None 的项
  - 确保参数级别的梯度正确对应
- 验证：梯度手术逻辑正确，不会因错位导致投影错误

### 如何验证 CRaFT 确实启用

**关键日志（必须出现）：**
```
✓ AnchorCache 加载成功: XXXX 样本
✓ CRaFT 已启用，将在训练中计算保留损失
```

**训练日志（每 K 步出现）：**
```
Step X/XXX | ... | L_ret=X.XXX | λ=X.XXX | ε=X.XXX | dot=X.XXX | cos=X.XXX
```

**失败标志（不应出现）：**
```
⚠ AnchorCache 加载失败
将以 baseline 模式运行（无保留损失）
```

**验证条件：**
1. craft.enabled=true 在配置中
2. craft.anchor_cache_dir 指向有效的 cache 目录
3. 日志显示"✓ CRaFT 已启用"
4. 训练日志包含 L_ret、λ、ε、dot、cos 指标

### 修改文件列表

1. `src/lerobot/scripts/lerobot_train_craft.py`
   - 移动 AnchorCache 加载到 preprocessor 创建后
   - 在训练循环中对 anchor_batch 应用 preprocessor
   - 实现 grad_dot 和 grad_cos 两个指标
   - 修复 compute_dot 调用（使用 zip 同位置配对）
   - 更新日志输出（同时显示 dot 和 cos）

2. `src/lerobot/craft/grad_surgery.py`
   - 修复 compute_dot() 实现
   - 使用 zip 同位置配对，避免错位
   - 跳过任一为 None 的梯度项

3. `tests.json`
   - 新增 craft_enabled_smoke 测试条目
   - 状态：in_progress
   - 包含验证条件和失败标志

4. `progress.txt`
   - 记录本次修复的三个问题
   - 添加验证方法说明

### Git Commit

```bash
git add src/lerobot/scripts/lerobot_train_craft.py
git add src/lerobot/craft/grad_surgery.py
git add tests.json
git add progress.txt
git commit -m "fix: ensure craft anchor loading works; correct grad conflict logging

- Fix: Move AnchorCache loading after preprocessor creation
- Fix: Apply preprocessor to anchor_batch in train loop (not in dataset)
- Fix: Implement both grad_dot and grad_cos metrics (was printing dot as cos)
- Fix: Use zip() for gradient dot product to avoid misalignment
- Add: craft_enabled_smoke test in tests.json
- Update: progress.txt with verification instructions"
```

---

## 历史记录

### 第五阶段：Hidden State Anchoring 实现（已完成，2025-02-17）

**目标：** 将 retention 分支从 token-level distillation 改为 hidden-state anchoring。

**完成内容：**
1. build_anchor_cache.py（完全重写）
2. retention_loss.py（完全重写）
3. anchor_cache.py（更新，向后兼容）
4. lerobot_train_craft.py（更新，自动检测 cache 类型）
5. test_hidden_state_anchoring.py（新增）

### 第四阶段：CRaFT 训练核心算法实现（已完成，2025-02-15）

**目标：** 实现 CRaFT 训练的核心算法逻辑，真正接入训练流程。

**完成内容：**
1. grad_surgery.py（完整实现）
2. primal_dual.py（完整实现）
3. craft_config.py（更新）
4. lerobot_train_craft.py（完整实现）
5. 训练脚本和文档

### 第三阶段：AnchorCache 离线生成和读取（已完成，2025-02-15）

**目标：** 实现 AnchorCache 的完整功能。

**完成内容：**
1. build_anchor_cache.py（550+ 行，token-level 版本）
2. anchor_cache.py（完整实现）
3. test_anchor_cache.py（300+ 行，5 个测试）
4. 文档

### 第二阶段：整理和注释（已完成）

**目标：** 为所有 CRaFT 相关文件添加详细中文注释。

### 第一阶段：脚手架搭建（已完成）

**目标：** 搭建 CRaFT 框架的基本结构。

---

## 项目文件结构

```
src/lerobot/craft/
├── __init__.py
├── craft_config.py
├── grad_surgery.py          # 修复：compute_dot 使用 zip 同位置配对
├── primal_dual.py
├── anchor_cache.py
├── retention_loss.py

src/lerobot/scripts/
├── build_anchor_cache.py
└── lerobot_train_craft.py   # 修复：preprocessor 顺序、梯度日志、anchor_batch 预处理

tests/
├── test_anchor_cache.py
├── test_hidden_state_anchoring.py
└── test_grad_surgery_math.py

scripts/
├── train_craft.sh
└── train_craft_dryrun.sh

docs/
├── CRAFT_FILES.md
├── ANCHOR_CACHE_GUIDE.md
├── ANCHOR_CACHE_SUMMARY.md
├── CRAFT_TRAINING_GUIDE.md
├── CRAFT_INTEGRATION_SUMMARY.md
└── HIDDEN_STATE_ANCHORING_GUIDE.md
```

## 下一步

1. 在服务器上运行 craft_enabled_smoke 测试
2. 验证 CRaFT 确实启用（看日志）
3. 在真实数据集上测试 hidden state anchoring
4. 对比 hidden state vs token-level 的性能
5. 性能优化和超参数调优
