# CRaFT Training Framework - Progress Tracker

## é¡¹ç›®æ¦‚è§ˆ
åœ¨ LeRobot çš„ pi0_fast è®­ç»ƒæµç¨‹ä¸­é›†æˆ CRaFT (Constrained Retention Fine-Tuning) æ¡†æ¶ã€‚

## å…³é”®æ–‡ä»¶è·¯å¾„

### è®­ç»ƒå…¥å£
- **Baseline è®­ç»ƒ**: `src/lerobot/scripts/lerobot_train.py`
  - ä¸»å‡½æ•°: `train(cfg: TrainPipelineConfig)`
  - è®­ç»ƒæ­¥å‡½æ•°: `update_policy()`
  - ä½¿ç”¨ Accelerator è¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒ
  - æ”¯æŒ wandb æ—¥å¿—è®°å½•

- **CRaFT è®­ç»ƒ**: `src/lerobot/scripts/lerobot_train_craft.py` (æ–°å¢)
  - ä¸»å‡½æ•°: `train_craft(cfg: TrainPipelineConfig)`
  - è®­ç»ƒæ­¥å‡½æ•°: `update_policy_craft()`
  - å¤ç”¨ baseline çš„é…ç½®è§£æå’Œæ•°æ®åŠ è½½é€»è¾‘

### Policy å®ç° (pi0_fast)
- **é…ç½®**: `src/lerobot/policies/pi0_fast/configuration_pi0_fast.py`
  - ç±»: `PI0FastConfig`
  - å…³é”®å‚æ•°: chunk_size=50, max_action_dim=32, max_state_dim=32

- **æ¨¡å‹**: `src/lerobot/policies/pi0_fast/modeling_pi0_fast.py`
  - ç±»: `PI0FastPolicy` (ç»§æ‰¿è‡ª PreTrainedPolicy)
  - forward() æ–¹æ³•è¿”å› (loss, output_dict)
  - åŸºäº PaliGemma çš„ VLA æ¶æ„

- **å¤„ç†å™¨**: `src/lerobot/policies/pi0_fast/processor_pi0_fast.py`
  - æ•°æ®é¢„å¤„ç†å’Œåå¤„ç†

### CRaFT æ¨¡å— (æ–°å¢)
- **åŒ…è·¯å¾„**: `src/lerobot/craft/`
- **é…ç½®**: `craft_config.py` - CraftConfig dataclass
- **æ¢¯åº¦æ‰‹æœ¯**: `grad_surgery.py` - æ¢¯åº¦æŠ•å½±å’Œåˆå¹¶
- **åŸå¯¹å¶ä¼˜åŒ–**: `primal_dual.py` - Î» æ›´æ–°å’Œ Îµ è°ƒåº¦
- **ä¿ç•™æŸå¤±**: `retention_loss.py` - é”šç‚¹æ•°æ®æŸå¤±è®¡ç®—
- **é”šç‚¹ç¼“å­˜**: `anchor_cache.py` - é”šç‚¹æ•°æ®é›†åŠ è½½

### æµ‹è¯•
- **å•å…ƒæµ‹è¯•**: `tests/test_grad_surgery_math.py` (æ–°å¢)
  - æ¢¯åº¦æ‰‹æœ¯æ•°å­¦è¿ç®—æµ‹è¯•

## å½“å‰é˜¶æ®µå®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆ
1. ä»“åº“ç»“æ„æ¢ç´¢å’Œå…³é”®æ–‡ä»¶å®šä½
2. craft åŒ…åˆ›å»ºï¼ŒåŒ…å«æ‰€æœ‰æ ¸å¿ƒæ¨¡å—ï¼ˆå‡½æ•°ç­¾åå’Œæ–‡æ¡£ï¼‰
3. lerobot_train_craft.py è®­ç»ƒå…¥å£è„šæœ¬ï¼ˆdry-run æ¨¡å¼ï¼‰
4. æµ‹è¯•æ–‡ä»¶æ¡†æ¶æ­å»º
5. æ–‡æ¡£åˆ›å»ºï¼ˆprogress.txt, tests.jsonï¼‰

### ğŸš§ å¾…å®ç°ï¼ˆä¸‹ä¸€é˜¶æ®µï¼‰
1. **anchor_cache.py**: å®ç° AnchorCacheDataset å’Œ create_anchor_dataloader
2. **retention_loss.py**: å®ç° compute_retention_lossï¼ˆè°ƒç”¨ policy.forwardï¼‰
3. **grad_surgery.py**: å®ç°æ¢¯åº¦ç‚¹ç§¯ã€æŠ•å½±ã€åˆå¹¶ç®—æ³•
4. **primal_dual.py**: å®ç° epsilon_schedule å’Œ update_lambda
5. **lerobot_train_craft.py**: å–æ¶ˆæ³¨é‡Š TODO éƒ¨åˆ†ï¼Œå®ç°å®Œæ•´è®­ç»ƒå¾ªç¯
6. **test_grad_surgery_math.py**: å®ç°å•å…ƒæµ‹è¯•

## è®­ç»ƒæµç¨‹å¯¹æ¯”

### Baseline (lerobot_train.py)
```
for step in range(cfg.steps):
    batch = next(dataloader)
    loss, output = policy.forward(batch)
    accelerator.backward(loss)
    optimizer.step()
```

### CRaFT (lerobot_train_craft.py)
```
for step in range(cfg.steps):
    # 1. Task loss
    task_batch = next(task_dataloader)
    task_loss, output = policy.forward(task_batch)
    accelerator.backward(task_loss)
    grad_task = extract_gradients()
    
    # 2. Retention loss
    anchor_batch = next(anchor_dataloader)
    retention_loss = compute_retention_loss(policy, anchor_batch)
    accelerator.backward(retention_loss)
    grad_retain = extract_gradients()
    
    # 3. Gradient surgery
    if use_projection:
        grad_task, grad_retain = project_if_conflict(grad_task, grad_retain)
    
    # 4. Merge gradients
    grad_final = merge_grads(grad_task, grad_retain, lambda_weight)
    
    # 5. Optimizer step
    set_gradients(grad_final)
    optimizer.step()
    
    # 6. Update lambda
    epsilon = epsilon_schedule(step)
    lambda_weight = update_lambda(lambda_weight, retention_loss, epsilon)
```

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ä¼˜å…ˆçº§ 1: æ ¸å¿ƒç®—æ³•å®ç°
- [ ] å®ç° grad_surgery.py çš„ä¸‰ä¸ªå‡½æ•°ï¼ˆæ•°å­¦æ ¸å¿ƒï¼‰
- [ ] å®ç° primal_dual.py çš„ä¸¤ä¸ªå‡½æ•°ï¼ˆä¼˜åŒ–æ ¸å¿ƒï¼‰
- [ ] å®ç° retention_loss.pyï¼ˆç®€å•å°è£…ï¼‰

### ä¼˜å…ˆçº§ 2: æ•°æ®ç®¡é“
- [ ] å®ç° anchor_cache.pyï¼ˆæ•°æ®åŠ è½½ï¼‰
- [ ] åœ¨ train_craft ä¸­é›†æˆé”šç‚¹æ•°æ®åŠ è½½

### ä¼˜å…ˆçº§ 3: è®­ç»ƒå¾ªç¯
- [ ] åœ¨ update_policy_craft ä¸­å®ç°åŒå‘åä¼ æ’­
- [ ] å®ç°æ¢¯åº¦æå–å’Œè®¾ç½®é€»è¾‘
- [ ] é›†æˆæ¢¯åº¦æ‰‹æœ¯å’Œ Î» æ›´æ–°

### ä¼˜å…ˆçº§ 4: æµ‹è¯•å’ŒéªŒè¯
- [ ] å®ç°å•å…ƒæµ‹è¯•
- [ ] åœ¨å°æ•°æ®é›†ä¸Šè¿è¡Œå®Œæ•´è®­ç»ƒ
- [ ] éªŒè¯ä¿ç•™çº¦æŸæ˜¯å¦ç”Ÿæ•ˆ

## éªŒè¯å‘½ä»¤

### Dry-run æµ‹è¯•ï¼ˆå½“å‰å¯ç”¨ï¼‰
```bash
python src/lerobot/scripts/lerobot_train_craft.py \
    --policy.type=pi0_fast \
    --dataset.repo_id=lerobot/aloha_sim_insertion_human \
    --batch_size=8 \
    --steps=1 \
    --output_dir=outputs/craft_dryrun
```

### å®Œæ•´è®­ç»ƒï¼ˆå¾…å®ç°åï¼‰
```bash
python src/lerobot/scripts/lerobot_train_craft.py \
    --policy.type=pi0_fast \
    --dataset.repo_id=lerobot/aloha_sim_insertion_human \
    --batch_size=32 \
    --steps=10000 \
    --output_dir=outputs/craft_full \
    --craft.anchor_dataset_path=path/to/anchor/data \
    --craft.initial_lambda=1.0 \
    --craft.epsilon_start=1.0 \
    --craft.epsilon_end=0.1
```

## æ³¨æ„äº‹é¡¹
1. **ä¸ä¿®æ”¹ baseline**: lerobot_train.py ä¿æŒä¸å˜
2. **ä¸ä¿®æ”¹ policy**: pi0_fast çš„ model/config/processor ä¸é‡å†™
3. **æ¨¡å—åŒ–è®¾è®¡**: craft åŒ…ç‹¬ç«‹ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
4. **æ¸è¿›å¼å¼€å‘**: å…ˆ dry-runï¼Œå†é€æ­¥å®ç°å®Œæ•´åŠŸèƒ½

